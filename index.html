<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mayoyao Genealogy Project</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        
        /* Navigation Menu */
        nav { background: var(--primary); display: flex; justify-content: center; padding: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        nav button { background: none; border: none; color: #bdc3c7; padding: 10px 20px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: 0.3s; }
        nav button:hover { color: white; }
        nav button.active { color: white; border-bottom: 3px solid var(--accent); }

        .view { display: none; max-width: 1100px; margin: 20px auto; padding: 20px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Search Bar */
        .search-box { width: 100%; max-width: 500px; padding: 12px 20px; margin: 20px auto; display: block; border-radius: 25px; border: 1px solid #ccc; font-size: 1rem; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Dashboard */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card h2 { margin: 0; font-size: 2.5rem; color: var(--accent); }

        /* Tree UI: Barangay > Clan > Names */
        .folder { background: white; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .folder-header { padding: 15px 20px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; transition: background 0.2s; }
        .folder-header:hover { background: #f9f9f9; }
        .folder-content { display: none; padding: 15px 20px; border-top: 1px solid #eee; background: #fafafa; }
        .folder.open > .folder-content { display: block; }

        .person-node { margin: 5px 0; }
        .person-box { display: inline-block; background: white; border: 1px solid #cbd5e0; padding: 8px 15px; border-radius: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.03); }
        .person-box strong { color: #2d3748; }
        .branch { margin-left: 30px; border-left: 2px dashed #cbd5e0; padding-left: 15px; margin-top: 5px; }
        
        .highlight { background: #fff3cd !important; border-color: #f6ad55 !important; }
        .tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #edf2f7; color: #4a5568; margin-left: 8px; vertical-align: middle; }
    </style>
</head>
<body>

<nav>
    <button onclick="switchView('about')">About</button>
    <button onclick="switchView('dashboard')">Dashboard</button>
    <button onclick="switchView('tree')" id="defaultTab">Family Tree</button>
    <button onclick="switchView('privacy')">Privacy</button>
</nav>

<div id="about" class="view">
    <h1>About the Project</h1>
    <p>The Mayoyao Genealogy Project is a community-driven digital archive. By mapping our history from 1945 to the present, we ensure that the stories of our ancestors and the growth of our clans are preserved for future generations.</p>
</div>

<div id="dashboard" class="view">
    <h1>Community Overview</h1>
    <div class="stats-container" id="statsGrid"></div>
</div>

<div id="tree" class="view">
    <input type="text" class="search-box" id="searchBar" placeholder="Search for a name (e.g. Baham or Hannah)...">
    <div id="treeOutput">Loading family records...</div>
</div>

<div id="privacy" class="view">
    <div class="card" style="text-align: left;">
        <h2>Data Privacy Notice</h2>
        <p>Your privacy is important. This platform follows these principles:</p>
        <ul>
            <li><strong>Purpose:</strong> Data is used solely for genealogical and historical research.</li>
            <li><strong>Scope:</strong> Records display Names, Birth/Death Years, and Clan affiliations.</li>
            <li><strong>Control:</strong> Families may request the removal or correction of their data by contacting the LGU administrator.</li>
        </ul>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHFdKL2QwhK8oAgG3gntgIxT5xSFzNj4cznnPYPzbP_qeCG8Q8DvVGcLox8gceV6S1yef5tgtIdwcw/pub?output=csv";
    let globalData = [];

    // 1. Navigation
    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        event.target.classList.add('active');
    }
    document.getElementById('defaultTab').click();

    // 2. Load Data
    Papa.parse(SHEET_URL, {
        download: true, header: true, skipEmptyLines: true,
        complete: (results) => {
            globalData = results.data;
            renderAll();
            setupSearch();
        }
    });

    function renderAll() {
        const treeContainer = document.getElementById("treeOutput");
        treeContainer.innerHTML = "";

        // Build Global Map (Solves Hannah/Baham issue)
        const personMap = new Map();
        const childIds = new Set();
        globalData.forEach(p => personMap.set(p.ID, { ...p, children: [] }));
        
        globalData.forEach(p => {
            ["Father ID", "Mother ID"].forEach(key => {
                const pId = p[key];
                if (pId && personMap.has(pId)) {
                    personMap.get(pId).children.push(personMap.get(p.ID));
                    childIds.add(p.ID);
                }
            });
        });

        // Group Roots by Location/Clan
        const structure = {};
        personMap.forEach((person, id) => {
            if (!childIds.has(id)) {
                const b = person.Barangay || "General";
                const c = person.Clan || "General";
                if (!structure[b]) structure[b] = {};
                if (!structure[b][c]) structure[b][c] = [];
                structure[b][c].push(person);
            }
        });

        // Render HTML Structure
        for (const [bName, clans] of Object.entries(structure)) {
            const bFolder = createFolder(`ðŸ“ Barangay: ${bName}`, 'barangay');
            const bContent = bFolder.querySelector('.folder-content');
            
            for (const [cName, roots] of Object.entries(clans)) {
                const cFolder = createFolder(`Clan: ${cName}`, 'clan');
                const cContent = cFolder.querySelector('.folder-content');
                roots.forEach(root => cContent.appendChild(renderNode(root)));
                bContent.appendChild(cFolder);
            }
            treeContainer.appendChild(bFolder);
        }

        updateDashboard();
    }

    function createFolder(title, type) {
        const div = document.createElement('div');
        div.className = `folder ${type}-folder`;
        div.innerHTML = `
            <div class="folder-header" onclick="this.parentElement.classList.toggle('open')">
                <span>${title}</span> <span>+</span>
            </div>
            <div class="folder-content"></div>
        `;
        return div;
    }

    function renderNode(person) {
        const div = document.createElement('div');
        div.className = "person-node";
        div.setAttribute('data-name', person["Full Name"].toLowerCase());
        div.innerHTML = `
            <div class="person-box">
                <strong>${person["Full Name"]}</strong>
                <span class="tag">${person.Barangay}</span>
            </div>
        `;
        if (person.children.length > 0) {
            const branch = document.createElement('div');
            branch.className = "branch";
            person.children.forEach(c => branch.appendChild(renderNode(c)));
            div.appendChild(branch);
        }
        return div;
    }

    // 3. Search Logic (Auto-expands folders)
    function setupSearch() {
        document.getElementById('searchBar').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.person-box').forEach(box => box.classList.remove('highlight'));
            
            if (term.length < 2) return;

            const matches = document.querySelectorAll(`.person-node[data-name*="${term}"]`);
            matches.forEach(match => {
                const box = match.querySelector('.person-box');
                box.classList.add('highlight');
                
                // Open all parent folders
                let parent = match.parentElement;
                while (parent) {
                    if (parent.classList.contains('folder')) parent.classList.add('open');
                    parent = parent.parentElement;
                }
                box.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        });
    }

    function updateDashboard() {
        const bCount = [...new Set(globalData.map(d => d.Barangay))].length;
        const cCount = [...new Set(globalData.map(d => d.Clan))].length;
        document.getElementById('statsGrid').innerHTML = `
            <div class="card"><h2>${globalData.length}</h2><p>People Recorded</p></div>
            <div class="card"><h2>${bCount}</h2><p>Barangays</p></div>
            <div class="card"><h2>${cCount}</h2><p>Active Clans</p></div>
        `;
    }
</script>
</body>
</html>
