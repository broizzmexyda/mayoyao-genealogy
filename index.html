<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mayoyao Genealogy Project</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: #333; }
        
        /* Navigation Menu */
        nav { background: var(--primary); display: flex; justify-content: center; padding: 0.5rem; position: sticky; top: 0; z-index: 1000; }
        nav button { background: none; border: none; color: white; padding: 12px 20px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        nav button:hover { background: rgba(255,255,255,0.1); border-radius: 4px; }
        nav button.active { border-bottom: 3px solid var(--accent); color: var(--accent); }

        /* Views */
        .view { display: none; max-width: 1000px; margin: 30px auto; padding: 20px; animation: fadeIn 0.4s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h3 { margin: 0; color: var(--accent); font-size: 2rem; }

        /* Tree Styles */
        .barangay-folder { background: white; margin-bottom: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .folder-header { padding: 15px; background: #fff; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .folder-header:hover { background: #f1f1f1; }
        .clan-container { display: none; padding: 10px 20px; background: #fafafa; border-top: 1px solid #eee; }
        
        .person-card { display: inline-block; background: white; border: 1px solid #d1d1d1; padding: 8px 12px; border-radius: 6px; margin: 4px 0; font-size: 0.9rem; }
        .tree-branch { margin-left: 25px; border-left: 1px dashed #bbb; padding-left: 15px; }
        
        .show { display: block !important; }
        .notice-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 20px; border-radius: 8px; line-height: 1.6; }
    </style>
</head>
<body>

<nav>
    <button onclick="showView('about')">About</button>
    <button onclick="showView('dashboard')">Dashboard</button>
    <button onclick="showView('tree')" class="active">Family Tree</button>
    <button onclick="showView('privacy')">Privacy Notice</button>
</nav>

<div id="about" class="view">
    <h1>About Mayoyao Genealogy</h1>
    <p>This digital archive preserves the ancestral lines of the Mayoyao community from 1945 to the present. Our goal is to connect generations and safeguard our cultural heritage.</p>
</div>

<div id="dashboard" class="view">
    <h1>Community Insights</h1>
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><h3>-</h3><p>Total Records</p></div>
        <div class="stat-card"><h3>-</h3><p>Barangays</p></div>
        <div class="stat-card"><h3>-</h3><p>Clans</p></div>
    </div>
</div>

<div id="tree" class="view active">
    <h1>Genealogy Records</h1>
    <div id="treeContainer">Loading data...</div>
</div>

<div id="privacy" class="view">
    <div class="notice-box">
        <h2>Data Privacy Notice</h2>
        <p>In accordance with the Data Privacy Act, all information contained here is for genealogical research and community connection. Publicly accessible data is limited to names and years of birth/death. If you wish to have your records updated or removed, please contact the LGU Mayoyao administrator.</p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHFdKL2QwhK8oAgG3gntgIxT5xSFzNj4cznnPYPzbP_qeCG8Q8DvVGcLox8gceV6S1yef5tgtIdwcw/pub?output=csv";
    let rawData = [];

    // Tab Navigation Logic
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // Data Fetching
    Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
            rawData = results.data;
            processAndRender(rawData);
        }
    });

    function processAndRender(data) {
        const container = document.getElementById("treeContainer");
        container.innerHTML = "";
        
        // 1. Update Dashboard Stats
        const barangays = [...new Set(data.map(d => d.Barangay))].filter(Boolean);
        const clans = [...new Set(data.map(d => d.Clan))].filter(Boolean);
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card"><h3>${data.length}</h3><p>Total Records</p></div>
            <div class="stat-card"><h3>${barangays.length}</h3><p>Barangays</p></div>
            <div class="stat-card"><h3>${clans.length}</h3><p>Clans</p></div>
        `;

        // 2. Build Global Relationship Map
        const personMap = new Map();
        const isChild = new Set();
        data.forEach(p => personMap.set(p.ID, { ...p, children: [] }));
        
        data.forEach(p => {
            ["Father ID", "Mother ID"].forEach(key => {
                const parentId = p[key];
                if (parentId && personMap.has(parentId)) {
                    personMap.get(parentId).children.push(personMap.get(p.ID));
                    isChild.add(p.ID);
                }
            });
        });

        // 3. Group Roots by Barangay -> Clan
        const structure = {};
        personMap.forEach((person, id) => {
            if (!isChild.has(id)) {
                const b = person.Barangay || "General";
                const c = person.Clan || "Other";
                if (!structure[b]) structure[b] = {};
                if (!structure[b][c]) structure[b][c] = [];
                structure[b][c].push(person);
            }
        });

        // 4. Render Nested UI
        for (const [bName, clanData] of Object.entries(structure)) {
            const bDiv = document.createElement('div');
            bDiv.className = 'barangay-folder';
            bDiv.innerHTML = `<div class="folder-header" onclick="toggle(this)">üìç Barangay: ${bName} <span>üìÇ</span></div>`;
            
            const clanContent = document.createElement('div');
            clanContent.className = 'clan-container';
            
            for (const [cName, roots] of Object.entries(clanData)) {
                const cDiv = document.createElement('div');
                cDiv.style.marginBottom = "20px";
                cDiv.innerHTML = `<div class="folder-header" onclick="toggle(this)" style="background:#eee">Clan: ${cName} <span>üå≥</span></div>`;
                
                const familyContent = document.createElement('div');
                familyContent.className = 'clan-container'; // Reuse container style
                roots.forEach(r => familyContent.appendChild(renderNode(r)));
                
                cDiv.appendChild(familyContent);
                clanContent.appendChild(cDiv);
            }
            
            bDiv.appendChild(clanContent);
            container.appendChild(bDiv);
        }
    }

    function renderNode(person) {
        const div = document.createElement('div');
        div.innerHTML = `
            <div class="person-card">
                <strong>${person["Full Name"]}</strong><br>
                <small>${person["Birth Year"] || '?'} - ${person["Death Year"] || 'Present'}</small>
            </div>
        `;
        if (person.children.length > 0) {
            const branch = document.createElement('div');
            branch.className = 'tree-branch';
            person.children.forEach(c => branch.appendChild(renderNode(c)));
            div.appendChild(branch);
        }
        return div;
    }

    function toggle(element) {
        const content = element.nextElementSibling;
        content.classList.toggle('show');
    }
</script>

</body>
</html>
